# Vulnerability Catalog

This document catalogs all deliberate security vulnerabilities in the Insecure-Monorepo for testing and training purposes.

## Table of Contents

1. [Injection Vulnerabilities](#injection-vulnerabilities)
2. [Authentication & Authorization](#authentication--authorization)
3. [Sensitive Data Exposure](#sensitive-data-exposure)
4. [Security Misconfiguration](#security-misconfiguration)
5. [Vulnerable Dependencies](#vulnerable-dependencies)
6. [Business Logic Flaws](#business-logic-flaws)
7. [Additional Vulnerabilities](#additional-vulnerabilities)

---

## Injection Vulnerabilities

### SQL Injection

**Severity**: Critical

**Location**: Multiple services

**Examples**:
- `users-service/src/index.ts` - Line ~30: Search endpoint
  ```typescript
  const query = `SELECT * FROM users WHERE username = '${username}'`;
  ```
  **Test**: `http://localhost:3001/api/users/search?username=admin'%20OR%20'1'='1`

- `users-service/src/index.ts` - Line ~75: Login endpoint
  ```typescript
  const query = `SELECT * FROM users WHERE username = '${username}' AND password = '${password}'`;
  ```
  **Test**: Login with `username: admin' OR '1'='1'--` and any password

- `products-service/src/index.ts` - Line ~50: Search endpoint
  ```typescript
  sqlQuery += ` AND name LIKE '%${query}%'`;
  ```
  **Test**: `http://localhost:3002/api/products/search?query=Laptop'%20OR%20'1'='1`

- `orders-service/src/index.ts` - Line ~45: User orders endpoint
  ```typescript
  let query = `SELECT * FROM orders WHERE userId = ${userId}`;
  ```

**Impact**: Attackers can read, modify, or delete database data, bypass authentication, and potentially execute commands on the database server.

### Command Injection

**Severity**: Critical

**Location**: Multiple packages and services

**Examples**:
- `packages/logging/src/index.ts` - Line ~53: Log rotation
  ```typescript
  const command = `gzip ${logPath}`;
  exec(command, ...);
  ```
  **Test**: Call with `logPath: "file.log; ls -la"`

- `users-service/src/index.ts` - Line ~125: Export endpoint
  ```typescript
  const command = `sqlite3 database.db ".mode ${format}" ...`;
  ```
  **Test**: POST with `format: "csv; cat /etc/passwd"`

**Impact**: Attackers can execute arbitrary commands on the server with the privileges of the application.

### Log Injection

**Severity**: Medium

**Location**: `packages/logging/src/index.ts`

**Example**:
- Line ~26: Direct message logging
  ```typescript
  return `${info.timestamp} [${serviceName}] ${info.level}: ${info.message}`;
  ```

**Test**: Log a message with newlines: `"User logged in\n[CRITICAL] System compromised"`

**Impact**: Attackers can inject fake log entries, hide malicious activity, or cause log parsing issues.

### XML External Entity (XXE)

**Severity**: High

**Location**: `products-service/src/index.ts`

**Example**:
- Line ~73: XML import endpoint
  ```typescript
  const parser = new xml2js.Parser({
    explicitRoot: false
  });
  ```

**Test**: POST to `/api/products/import` with:
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<product>&xxe;</product>
```

**Impact**: Read local files, perform SSRF attacks, cause denial of service.

---

## Authentication & Authorization

### Weak JWT Implementation

**Severity**: Critical

**Location**: `packages/auth/src/index.ts`

**Examples**:
- Line ~5: Hardcoded secret
  ```typescript
  const JWT_SECRET = 'secret123';
  ```

- Line ~20: Algorithm acceptance
  ```typescript
  generateToken(user: User, algorithm: string = 'HS256')
  ```

- Line ~38: Accepting 'none' algorithm
  ```typescript
  algorithms: ['HS256', 'none']
  ```

**Test**: 
1. Generate token with 'none' algorithm
2. Decode token and modify payload
3. Submit token without signature

**Impact**: Token forgery, privilege escalation, authentication bypass.

### Weak Password Hashing

**Severity**: High

**Location**: `packages/auth/src/index.ts`

**Example**:
- Line ~48: Low salt rounds
  ```typescript
  const saltRounds = 4;
  ```

**Impact**: Passwords can be cracked more easily with brute force attacks.

### Missing Authorization Checks (IDOR)

**Severity**: High

**Location**: Multiple services

**Examples**:
- `users-service/src/index.ts` - Line ~88: Get user endpoint
  ```typescript
  // No authorization check - any user can view any user
  ```

- `orders-service/src/index.ts` - Line ~37: Get order endpoint
  ```typescript
  // No authorization check - any user can view any order
  ```

**Test**: Access `/api/orders/1`, `/api/orders/2`, etc. without authentication

**Impact**: Unauthorized access to sensitive data belonging to other users.

### Privilege Escalation

**Severity**: Critical

**Location**: `users-service/src/index.ts`

**Example**:
- Line ~107: Update role endpoint
  ```typescript
  // No authorization check - any user can change roles
  app.put('/api/users/:id/role', ...);
  ```

**Test**: PUT to `/api/users/1/role` with `{"role": "admin"}`

**Impact**: Regular users can elevate their privileges to administrator.

### Mass Assignment

**Severity**: High

**Location**: Multiple services

**Examples**:
- `users-service/src/index.ts` - Line ~62: Create user
  ```typescript
  const { username, email, password, role } = req.body;
  ```

**Test**: POST with `{"username":"test","email":"test@test.com","password":"pass","role":"admin"}`

**Impact**: Users can set fields they shouldn't have access to, like roles or permissions.

---

## Sensitive Data Exposure

### Hardcoded Credentials

**Severity**: Critical

**Location**: `packages/config/src/index.ts`

**Examples**:
- Lines ~28-30: Database credentials
  ```typescript
  username: 'admin',
  password: 'P@ssw0rd123!',
  ```

- Lines ~37-39: AWS credentials
  ```typescript
  accessKeyId: 'AKIAIOSFODNN7EXAMPLE',
  secretAccessKey: 'wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY'
  ```

- Line ~35: API secret key
  ```typescript
  secretKey: 'super-secret-key-12345'
  ```

**Impact**: Credentials discovered in source code can lead to complete system compromise.

### Sensitive Data in Logs

**Severity**: High

**Location**: Multiple services

**Examples**:
- `packages/logging/src/index.ts` - Line ~76: User activity logging
  ```typescript
  logUserActivity(username: string, action: string, data: any)
  // Logs complete data object without redaction
  ```

- `orders-service/src/index.ts` - Line ~117: Payment logging
  ```typescript
  logger.info(`Payment processed for order ${id}: Card ${cardNumber}, CVV ${cvv}`);
  ```

**Test**: Process payment and check logs for credit card data

**Impact**: Sensitive data like passwords, credit cards exposed in logs.

### Plaintext Storage of Sensitive Data

**Severity**: Critical

**Location**: `orders-service/src/index.ts`

**Example**:
- Line ~110: Payment storage
  ```typescript
  const query = 'INSERT INTO payments (orderId, amount, cardNumber, cvv, expiryDate) VALUES (?, ?, ?, ?, ?)';
  ```

**Test**: Create payment and retrieve it via `/api/orders/:id/payment`

**Impact**: Credit card data stored in plaintext violates PCI-DSS.

### Information Disclosure

**Severity**: Medium to High

**Location**: Multiple services

**Examples**:
- `users-service/src/index.ts` - Line ~146: Debug endpoint
  ```typescript
  res.json(configManager.getFullConfig());
  ```

- `api-gateway/src/index.ts` - Line ~185: Debug endpoint
  ```typescript
  res.json({
    env: process.env,
    config: configManager.getFullConfig(),
    ...
  });
  ```

- `api-gateway/src/index.ts` - Line ~84: Service URLs
  ```typescript
  res.json(SERVICES);
  ```

**Test**: GET `/api/debug/config` or `/api/debug`

**Impact**: Exposure of internal configuration, secrets, and infrastructure details.

---

## Security Misconfiguration

### CORS Misconfiguration

**Severity**: Medium

**Location**: All services

**Example**:
- `api-gateway/src/index.ts` - Line ~23:
  ```typescript
  app.use(cors({
    origin: '*',
    credentials: true
  }));
  ```

**Impact**: Any website can make authenticated requests to the API.

### Weak Rate Limiting

**Severity**: Medium

**Location**: `api-gateway/src/index.ts`

**Example**:
- Line ~16:
  ```typescript
  max: 1000, // Too high limit
  ```

**Impact**: Vulnerable to brute force, DoS attacks.

### Stack Trace Exposure

**Severity**: Low

**Location**: `api-gateway/src/index.ts`

**Example**:
- Line ~209: Error handler
  ```typescript
  res.status(500).json({
    error: err.message,
    stack: err.stack
  });
  ```

**Impact**: Exposes internal implementation details to attackers.

### Running as Root in Docker

**Severity**: Medium

**Location**: All Dockerfiles

**Example**:
- No USER directive in Dockerfiles
- Containers run as root by default

**Impact**: Container escape vulnerabilities can lead to host compromise.

---

## Vulnerable Dependencies

### Outdated axios (0.21.1)

**Severity**: High

**Location**: `orders-service/package.json`, `api-gateway/package.json`

**Known CVEs**:
- CVE-2021-3749: Regular expression denial of service
- CVE-2020-28168: Server-Side Request Forgery

**Impact**: SSRF, DoS vulnerabilities.

### Old js-yaml (3.13.1)

**Severity**: High

**Location**: `packages/config/package.json`

**Known CVEs**:
- CVE-2021-35065: Code execution via load method

**Impact**: Remote code execution through YAML deserialization.

### Old jsonwebtoken (8.5.1)

**Severity**: Medium

**Location**: `packages/auth/package.json`

**Known CVEs**:
- Various algorithm confusion vulnerabilities

**Impact**: JWT signature bypass.

---

## Business Logic Flaws

### Race Conditions

**Severity**: Medium

**Location**: `orders-service/src/index.ts`

**Example**:
- Line ~66: Order processing
  ```typescript
  // No transaction handling - race condition possible
  ```

**Test**: Send multiple concurrent order requests for the same product

**Impact**: Overselling inventory, double-spending.

### Negative Quantities

**Severity**: Medium

**Location**: `orders-service/src/index.ts`

**Example**:
- Line ~144: Update order
  ```typescript
  // No validation for negative quantities
  ```

**Test**: PUT `/api/orders/:id` with `{"quantity": -1}`

**Impact**: Logic errors, inventory manipulation.

### Timing Attacks

**Severity**: Low

**Location**: `packages/auth/src/index.ts`

**Example**:
- Line ~53: Password comparison
  ```typescript
  async comparePasswordUnsafe(password: string, hash: string)
  ```

**Impact**: Password enumeration through timing analysis.

---

## Additional Vulnerabilities

### Server-Side Request Forgery (SSRF)

**Severity**: High

**Location**: Multiple services

**Examples**:
- `users-service/src/index.ts` - Line ~157: Avatar endpoint
  ```typescript
  https.get(url, ...);
  ```

- `orders-service/src/index.ts` - Line ~133: Notify endpoint
  ```typescript
  const response = await axios.post(webhookUrl, ...);
  ```

- `api-gateway/src/index.ts` - Line ~155: Proxy endpoint
  ```typescript
  const response = await axios({ method, url, data });
  ```

**Test**: POST with `{"url": "http://localhost:3001/api/debug/config"}`

**Impact**: Access to internal services, cloud metadata, port scanning.

### Path Traversal

**Severity**: High

**Location**: Multiple locations

**Examples**:
- `packages/logging/src/index.ts` - Line ~63: Read log
  ```typescript
  const logPath = path.join('/var/log', filename);
  ```

- `products-service/src/index.ts` - Line ~94: Image endpoint
  ```typescript
  const imagePath = path.join('/var/www/images', filename);
  ```

**Test**: GET `/api/products/image/../../etc/passwd`

**Impact**: Read arbitrary files on the server.

### Open Redirect

**Severity**: Low

**Location**: Multiple services

**Examples**:
- `api-gateway/src/index.ts` - Line ~148:
  ```typescript
  res.redirect(url as string);
  ```

- `products-service/src/index.ts` - Line ~156:
  ```typescript
  res.redirect(url as string);
  ```

**Test**: GET `/api/redirect?url=https://evil.com`

**Impact**: Phishing attacks using trusted domain.

### Regular Expression Denial of Service (ReDoS)

**Severity**: Medium

**Location**: `products-service/src/index.ts`

**Example**:
- Line ~149:
  ```typescript
  const regex = /^(a+)+$/;
  ```

**Test**: GET `/api/products/validate?productName=aaaaaaaaaaaaaaaaaaaaaaaaaaaa!`

**Impact**: CPU exhaustion, denial of service.

### Insecure Deserialization

**Severity**: High

**Location**: Multiple locations

**Examples**:
- `packages/config/src/index.ts` - Line ~82: Dynamic config
  ```typescript
  const dynamicConfig = eval(`(${configCode})`);
  ```

- `orders-service/src/index.ts` - Line ~179: Import endpoint
  ```typescript
  const orders = JSON.parse(data);
  ```

**Test**: Send specially crafted JSON with prototype pollution payloads

**Impact**: Remote code execution, data corruption.

### Missing Security Headers

**Severity**: Low

**Location**: All services

**Missing headers**:
- X-Frame-Options
- X-Content-Type-Options
- Content-Security-Policy
- Strict-Transport-Security

**Impact**: XSS, clickjacking vulnerabilities.

---

## Testing Recommendations

### Tools for Detection

1. **Static Analysis**:
   - GitHub Advanced Security (CodeQL)
   - Fortify/OpenText SCA
   - SonarQube
   - Snyk

2. **Dynamic Analysis**:
   - OWASP ZAP
   - Burp Suite
   - SQLMap
   - Nikto

3. **Dependency Scanning**:
   - npm audit
   - Snyk
   - Dependabot

### Manual Testing Checklist

- [ ] SQL Injection in all query parameters
- [ ] Command injection in file operations
- [ ] XXE in XML processing endpoints
- [ ] JWT manipulation (none algorithm, weak secret)
- [ ] IDOR by accessing different user IDs
- [ ] Mass assignment by adding role fields
- [ ] SSRF by providing internal URLs
- [ ] Path traversal with `../` sequences
- [ ] Open redirects with external URLs
- [ ] ReDoS with long strings

---

## Disclaimer

⚠️ **All vulnerabilities in this repository are intentional and for educational purposes only. Never deploy this code in production or expose it to the internet.**
