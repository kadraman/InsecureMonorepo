name: "CI - Project (reusable)"

on:
  workflow_call:
    inputs:
      project_path:
        required: true
        type: string
      node-version:
        required: false
        type: string
        default: '18'
      runner:
        required: false
        type: string
        default: 'ubuntu-latest'

jobs:
  build-and-test:
    # Runner is parameterized so callers can choose the runner
    runs-on: ${{ inputs.runner }}
    concurrency:
      group: ci-project-${{ inputs.project_path }}
      cancel-in-progress: false
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Debug prints added to help diagnose workspace/layout/build problems
      - name: Debug - inputs and runner info
        run: |
          echo "--- Workflow inputs ---"
          echo "project_path=${{ inputs.project_path }}"
          echo "node-version=${{ inputs.node-version }}"
          echo "runner=${{ inputs.runner }}"
          echo "--- Runner / env ---"
          uname -a || true
          echo "USER: $(whoami)" || true
          echo "PWD: $(pwd)"
          ls -la . | sed -n '1,200p'

      - name: Debug - Node / npm / pnpm info
        run: |
          echo "Node & npm versions"
          node -v || true
          npm -v || true
          which node || true
          which npm || true
          echo "--- NPM config (short) ---"
          npm config ls --json 2>/dev/null | sed -n '1,200p' || true

      - name: Debug - repo layout & key files
        run: |
          echo "Top-level package.json:"; sed -n '1,200p' package.json || true
          echo "Top-level package-lock.json (if exists):"; ls -la package-lock.json || true
          echo "Packages directory listing (first 200 lines):"; ls -la packages | sed -n '1,200p' || true
          echo "Services directory listing (first 200 lines):"; ls -la services | sed -n '1,200p' || true
          echo "Project package.json (if exists):"; if [ -f "${{ inputs.project_path }}/package.json" ]; then sed -n '1,200p' "${{ inputs.project_path }}/package.json"; else echo '(none)'; fi
          echo "Project tsconfig (if exists):"; if [ -f "${{ inputs.project_path }}/tsconfig.json" ]; then sed -n '1,200p' "${{ inputs.project_path }}/tsconfig.json"; else echo '(none)'; fi

      - name: Debug - short npm workspace view
        run: |
          echo "Running npm -w . ls --depth=0 (may error if no install yet)"
          npm ls --workspaces --depth=0 2>/dev/null | sed -n '1,200p' || true

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Cache root node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
          key: ${{ runner.os }}-root-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-root-node-

      - name: Cache project node_modules
        uses: actions/cache@v4
        with:
          path: |
            ${{ inputs.project_path }}/node_modules
          key: ${{ runner.os }}-project-node-${{ inputs.project_path }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-project-node-${{ inputs.project_path }}-

      - name: Cache TypeScript outputs (dist and tsbuildinfo)
        uses: actions/cache@v4
        with:
          path: |
            ${{ inputs.project_path }}/dist
            ${{ inputs.project_path }}/*.tsbuildinfo
            packages/*/dist
            packages/*/*.tsbuildinfo
          key: ${{ runner.os }}-ts-out-${{ inputs.project_path }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-ts-out-${{ inputs.project_path }}-

      - name: Install dependencies (root)
        run: npm ci

      - name: Clean TypeScript buildinfo and dists (optional)
        run: |
          echo "Removing tsbuildinfo and dist folders to avoid stale incremental state"
          find . -name "*.tsbuildinfo" -print -delete || true
          find packages -type d -name dist -prune -exec rm -rf '{}' + || true

      - name: Build package projects (force) when applicable
        run: |
          TARGET_TSC="${{ inputs.project_path }}/tsconfig.json"
          if [ -f "$TARGET_TSC" ]; then
            echo "Found $TARGET_TSC - forcing package builds then target build"
            # Force rebuild packages first, then the target project
            npx -y tsc -b packages/*/tsconfig.json --force || true
            npx -y tsc -b "$TARGET_TSC" --force
          else
            echo "No tsconfig at $TARGET_TSC - skipping tsc -b"
          fi

      - name: Build (workspace preferred, fallback)
        run: |
          if [[ "${{ inputs.project_path }}" == services/* ]]; then
            echo "Running workspace-aware service build for ${{ inputs.project_path }}"
            npm --workspace=${{ inputs.project_path }} run build --if-present || (cd "${{ inputs.project_path }}" && npm run build --if-present)
          else
            npm --workspace=${{ inputs.project_path }} run build --if-present || (cd "${{ inputs.project_path }}" && npm ci && npm run build --if-present)
          fi

      - name: Test (workspace preferred, fallback)
        run: |
          echo "Skipping tests ..."
          #npm --workspace=${{ inputs.project_path }} run test --if-present || (cd "${{ inputs.project_path }}" && npm ci && npm run test --if-present)
